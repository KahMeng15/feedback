<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feedback & Error Report</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ====== Layout & Theme ====== */
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#4f46e5; --success:#16a34a;
      --danger:#ef4444; --glass: rgba(255,255,255,0.03);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#07102a 0%, #051025 100%); color:#e6eef8;
      display:flex; align-items:center; justify-content:center; padding:36px;
      font-family: "Inter", sans-serif;
    }
    .card{
      width:100%; max-width:820px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px; padding:28px; box-shadow: 0 10px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03);
      backdrop-filter: blur(6px);
    }
    header{display:flex; gap:16px; align-items:center; margin-bottom:18px}
    .logo{
      height:56px; width:auto; display:flex; align-items:center; justify-content:center;
      max-width:100%; object-fit:contain;
    }
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 0;color:var(--muted); font-size:13px}
    form{display:grid; gap:12px; margin-top:14px}
    .row{display:flex; gap:12px}
    .col{flex:1}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input, textarea{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04);
      background:var(--glass); color:inherit; font-size:14px; outline:none; transition:box-shadow .15s, border-color .15s;
      font-family: "Inter", sans-serif;
    }
    input:focus, textarea:focus{box-shadow:0 6px 18px rgba(79,70,229,0.12); border-color: rgba(79,70,229,0.6)}
    textarea{min-height:130px; resize:vertical}
    .muted{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center; margin-top:8px}
    .btn{
      display:inline-flex; gap:8px; align-items:center; justify-content:center; padding:10px 14px;
      background:var(--accent); color:white; border-radius:10px; border:0; cursor:pointer; font-weight:600;
    }
    .btn.secondary{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted)}
    .btn[disabled]{opacity:0.6; cursor:not-allowed}
    .note{font-size:13px; color:var(--muted)}
    .toast{padding:10px 12px; border-radius:8px; font-weight:600; font-size:13px}
    .toast.success{background:rgba(22,163,74,0.12); color:var(--success); border:1px solid rgba(22,163,74,0.08)}
    .toast.error{background:rgba(239,68,68,0.08); color:var(--danger); border:1px solid rgba(239,68,68,0.08)}
    footer{margin-top:16px; display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted)}
    /* ====== Responsive ====== */
    @media (max-width:640px){
      body{padding:10px;}
      .card{padding:12px;}
      header{gap:10px; margin-bottom:12px;}
      .logo{height:44px; max-width:80px;}
      h1{font-size:17px;}
      .row{flex-direction:column; gap:8px;}
      .modal-content{padding:20px; max-width:95vw;}
      form{gap:8px;}
    }
    @media (max-width:400px){
      .logo{height:32px; max-width:56px;}
      h1{font-size:15px;}
      .card{padding:6px;}
      .modal-content{padding:10px 2px 10px 2px;}
    }
    /* ====== Modal Dialog ====== */
    .modal {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(15,23,36,0.65); z-index: 9999;
      transition: opacity .2s;
    }
    .modal-content {
      background: var(--card);
      color: #e6eef8;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      padding: 32px 28px 24px 28px;
      max-width: 340px;
      text-align: center;
      font-family: "Inter", sans-serif;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .modal-content h2 {
      margin: 0 0 10px 0;
      font-size: 20px;
      color: var(--success);
    }
    .modal-content p {
      margin: 0 0 18px 0;
      font-size: 15px;
      color: var(--muted);
    }
    .modal-content .btn {
      min-width: 100px;
      font-size: 15px;
      padding: 10px 0;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="pageTitle">
    <header>
      <img class="logo" src="logo.png" alt="Logo">
      <div>
        <h1 id="pageTitle">Feedback & Error Report</h1>
        <p class="lead">Tell me what happened. A bug, feedback or anything I should know.</p>
      </div>
    </header>
    <!-- ====== Feedback Form ====== -->
    <form id="feedbackForm" novalidate>
      <div class="row">
        <div class="col">
          <label for="name">Your name <span aria-hidden="true">*</span></label>
          <input type="text" id="name" name="name" required />
        </div>
        <div class="col">
          <label for="email">Email <span aria-hidden="true">*</span></label>
          <input type="email" id="email" name="email" required />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="mobile">Mobile number</label>
          <input type="tel" id="mobile" name="mobile" />
        </div>
        <div class="col">
          <label for="subject">Subject / Short description</label>
          <input type="text" id="subject" name="subject" />
        </div>
      </div>
      <div>
        <label for="message">Message <span aria-hidden="true">*</span></label>
        <textarea id="message" name="message" required></textarea>
        <div class="muted" style="margin-top:6px">Please include steps to reproduce, expected behavior, device/browser info if possible.</div>
      </div>
      <div class="actions">
        <button type="submit" id="submitBtn" class="btn">Send feedback</button>
        <button type="button" id="clearBtn" class="btn secondary">Clear</button>
        <div id="status" style="margin-left:auto"></div>
      </div>
    </form>
  </div>
  <script>
    // ====== Firebase SDK Setup ======
    // Load Firebase SDK from CDN
    const firebaseScript = document.createElement('script');
    firebaseScript.src = "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js";
    firebaseScript.onload = () => {
      const databaseScript = document.createElement('script');
      databaseScript.src = "https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js";
      databaseScript.onload = main;
      document.head.appendChild(databaseScript);
    };
    document.head.appendChild(firebaseScript);

    function main() {
      // ====== Configuration ======
      const APPS_SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxHiKLcue-bq2qcI5n23RFfzKy4dIiOy2qfktEdApXSJEKjHKNBajSa97SSkziHTcAjkw/exec';
      const form = document.getElementById('feedbackForm');
      const statusWrap = document.getElementById('status');
      const submitBtn = document.getElementById('submitBtn');
      const clearBtn = document.getElementById('clearBtn');

      // ====== Firebase Config ======
      const firebaseConfig = {
        apiKey: "AIzaSyDgnTuBwdKllvFfbEiWBUvNhgu-UBV7fCg",
        authDomain: "kahmeng-ff858.firebaseapp.com",
        databaseURL: "https://kahmeng-ff858-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kahmeng-ff858",
        storageBucket: "kahmeng-ff858.firebasestorage.app",
        messagingSenderId: "710918459801",
        appId: "1:710918459801:web:b6f79cc8a29cf45a7e4308",
        measurementId: "G-WEX1JLXG31"
      };

      // ====== UI Helpers ======
      function showStatus(type, text, timeout=4500){
        statusWrap.innerHTML = '';
        const d = document.createElement('div');
        d.className = 'toast ' + (type === 'success' ? 'success': 'error');
        d.textContent = text;
        statusWrap.appendChild(d);
        if(timeout) setTimeout(()=> { statusWrap.innerHTML = '' }, timeout);
      }
      function showModalDialog(message) {
        const oldModal = document.getElementById('customModalDialog');
        if (oldModal) oldModal.remove();
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'customModalDialog';
        const content = document.createElement('div');
        content.className = 'modal-content';
        content.innerHTML = `
          <h2>Feedback Status</h2>
          <p>${message}</p>
          <button class="btn" id="closeModalBtn" type="button">OK</button>
        `;
        modal.appendChild(content);
        document.body.appendChild(modal);
        document.getElementById('closeModalBtn').onclick = function() {
          modal.remove();
        };
      }

      // ====== Validation Helpers ======
      function capitalizeWords(str) {
        return str.replace(/\b\w+/g, function(word) {
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        });
      }
      function isValidEmail(email) {
        return /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/.test(email);
      }
      function formatMalaysianMobile(mobile) {
        let num = mobile.replace(/[\s\-()]/g, '');
        if(num.startsWith('+')) {
          num = num.replace(/^\+60/, '');
        } else if(num.startsWith('60')) {
          num = num.replace(/^60/, '');
        } else if(num.startsWith('0')) {
          num = num.replace(/^0/, '');
        }
        num = num.replace(/[^0-9]/g, '');
        if(num.length === 9 || num.length === 10) {
          return '+60' + num;
        }
        return '';
      }

      // ====== Form Actions ======
      clearBtn.addEventListener('click', ()=> form.reset());
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        let name = form.name.value.trim();
        let email = form.email.value.trim();
        let mobile = form.mobile.value.trim();
        let subject = form.subject.value.trim();
        let message = form.message.value.trim();
        name = capitalizeWords(name);
        email = email.toLowerCase();
        if(!isValidEmail(email)){
          showStatus('error','Please enter a valid email address.');
          return;
        }
        // Accept any mobile number format, no validation or formatting
        if(!name || !email || !message){
          showStatus('error','Please fill required fields: Name, Email and Message.');
          return;
        }
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
        // Build payload for Apps Script
        const payload = {
          name, email, mobile, subject, message,
          url: window.location.href,
          userAgent: navigator.userAgent,
          timestamp: new Date().toISOString()
        };

        // ====== Push to Firebase Database ======
        try {
          // Open Firebase connection only when needed
          if (!window.firebaseApp) {
            window.firebaseApp = firebase.initializeApp(firebaseConfig);
          }
          const db = firebase.database();
          await db.ref('feedbacks').push(payload);
        } catch (err) {
          // Firebase error, but continue to Apps Script
          console.error('Firebase error:', err);
        }

        // Build URL-encoded body to avoid preflight OPTIONS
        const params = new URLSearchParams();
        Object.keys(payload).forEach(k => {
          const v = (payload[k] === undefined || payload[k] === null) ? '' : String(payload[k]);
          params.append(k, v);
        });
        try {
          const res = await fetch(APPS_SCRIPT_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body: params.toString()
          });
          const data = await res.json().catch(()=>({ok:false, statusText: 'Invalid response'}));
          let msg = '';
          if(res.ok && data && data.status === 'success'){
            msg = 'Feedback received, thank you!';
            showModalDialog(msg);
            form.reset();
          } else {
            msg = (data && data.message) ? data.message : (res.statusText || 'Server error');
            showModalDialog('Failed: ' + msg);
          }
        } catch (err) {
          showModalDialog('Network or server error. Try again later.');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send feedback';
        }
        // Optionally, "close" Firebase connection (no explicit close in SDK)
      });
    }
  </script>
</body>
</html>